# DF1激光雷达通信协议

|     版本号      | 修订时间  | 修改概述 |
| :-------------: | :-------: | :------: |
| df1雷达协议V1.0 | 2025/4/21 |   初版   |

## 1.1 控制指令

### 1.1.1 指令帧格式

在通信过程中，雷达被定义为slave，接收点云数据的设备被定义为master，通信数据在master和slave之间以基于消息的方式交换，控制消息协议格式如下：

|      字段       | 偏移（字节） | 大小（字节） | 描述                                                         |
| :-------------: | :----------: | :----------: | :----------------------------------------------------------- |
|       sof       |      0       |      2       | 03 03                                                        |
|     version     |      2       |      1       | 当前协议版本为0                                              |
|     length      |      3       |      2       | 指令帧长度                                                   |
|    cmd_type     |      5       |      1       | 指令类型：<br />0x00： CMD<br />0x01： ACK<br />0x02： MSG   |
|     cmd_id      |      6       |      2       | 指令ID详见1.1.3                                              |
|     seq_num     |      8       |      2       | 每条新的REQ请求消息此字段递增1；<br/>ACK回复消息此字段与REQ相同，可用于消息匹配； |
| Header Checksum |      10      |      2       | 和校验（作用域为sof~seq_num)                                 |
|    **data**     |    **12**    |    **n**     | **数据**                                                     |
|  Data Checksum  |     12+n     |      2       | 和校验（作用域为data）                                       |

通信数据以高位在前低位在后的格式发送。**IP相关的设置重启之后才能生效。**

### 1.1.2 控制应答

应答信息指令格式：

|      字段       | 偏移（字节） | 大小（字节） | 描述                                                         |
| :-------------: | :----------: | :----------: | :----------------------------------------------------------- |
|       sof       |      0       |      2       | 03 03                                                        |
|     version     |      2       |      1       | 当前协议版本为0                                              |
|     length      |      3       |      2       | 指令帧长度                                                   |
|    cmd_type     |      5       |      1       | 指令类型：<br />0x00： CMD<br />0x01： ACK<br />0x02： MSG   |
|     cmd_id      |      6       |      2       | 指令ID详见1.1.3                                              |
|     seq_num     |      8       |      2       | 每条新的REQ请求消息此字段递增1；<br/>ACK回复消息此字段与REQ相同，可用于消息匹配； |
| Header Checksum |      10      |      2       | 和校验（作用域为sof~seq_num)                                 |
|    **data**     |    **12**    |    **n**     | **返回信息（详见下表）**                                     |
|  Data Checksum  |     12+n     |      2       | 和校验（作用域为data）                                       |

data：

| ACK  |   名称   | 偏移字节 | 大小（字节） |  描述  |
| :--: | :------: | :------: | :----------: | :----: |
| data | ret_code |    0     |      2       | 返回码 |
|      |    ……    |    ……    |      ……      |   ……   |

ret_code：

| 返回值 | 偏移（字节） | 大小（字节） |       描述       |
| :----: | :----------: | :----------: | :--------------: |
| 0x0000 |              |      2       |     执行成功     |
| 0x0100 |              |      2       |    雷达未连接    |
| 0x0101 |              |      2       |   指令长度不对   |
| 0x0102 |              |      2       |  指令头校验失败  |
| 0x0103 |              |      2       | 指令数据校验失败 |

### 1.1.3 指令ID

| 功能分类                                 | cmd_id   | 描述                                             | 进度                           |
| :--------------------------------------- | -------- | :----------------------------------------------- | :----------------------------- |
| 设备IP等信息                             | 16'h0000 | 广播：雷达主动在网络上特定端口定时广播自己的IP   | 功能上板自测试已完成           |
|                                          | 16'h0001 | 心跳：上位机或者驱动发送心跳                     | 代码已添加，功能未在雷达上测试 |
| 雷达参数设置                             | 16'h0100 | 请求连接：上位机或者驱动发送带密码字段的连接请求 | 功能上板自测试已完成           |
|                                          | 16'h0101 | 断开连接：退出连接状态                           | 功能上板自测试已完成           |
|                                          | 16'h0102 | 保存参数                                         | 功能上板自测试已完成           |
|                                          | 16'h0103 | 设置雷达IP                                       | 功能上板自测试已完成           |
|                                          | 16'h0104 | 设置雷达MAC                                      | 功能上板自测试已完成           |
|                                          | ……       | ……                                               |                                |
| 雷达参数查询                             | 16'h0200 | 查询雷达IP                                       | 功能上板自测试已完成           |
|                                          | 16'h0201 | 查询雷达MAC                                      | 功能上板自测试已完成           |
|                                          | 16'h0202 | 查询雷达固件版本号                               | 功能上板自测试已完成           |
|                                          | ……       | ……                                               |                                |
| 雷达系数相关                             | 16'h0300 | 写入距离计算系数                                 | 代码已添加，功能未在雷达上测试 |
|                                          | 16'h0301 | 查询距离计算系数                                 |                                |
|                                          | 16'h0302 | 写入反射率计算系数                               | 代码已添加，功能未在雷达上测试 |
|                                          | 16'h0303 | 查询反射率计算系数                               |                                |
|                                          | 16'h0304 | 写入空间角度计算系数                             | 代码未添加，功能未在雷达上测试 |
|                                          | 16'h0305 | 查询空间角度计算系数                             |                                |
| 获取点云数据                             | 16'h1000 | 单次取数，只有数据                               | 代码已添加，功能未在雷达上测试 |
|                                          | 16'h1001 | 连续数据                                         | 代码已添加，功能未在雷达上测试 |
| 雷达测试相关指令（开发人员获取内部信息） | 16'h2000 | 输出标定数据                                     | 功能上板自测试已完成           |
|                                          | 16'h2001 | 读取码盘1的时钟计数                              | 功能上板自测试已完成           |
|                                          | 16'h2002 | 读取码盘2的时钟计数                              | 功能上板自测试已完成           |

### 1.1.4 指令详解

#### 1.1.4.1 雷达连接相关

##### 1.1.4.1.1 0x0000 广播发现

雷达未连接时定时广播雷达IP、MAC等设备信息，连接成功后停止广播

| ACK  |     名称      | 偏移(字节) | 大小（字节） |    描述     |
| :--: | :-----------: | :--------: | :----------: | :---------: |
| data |   ret_code    |     0      |      2       |   返回码    |
|      |   dev_type    |     2      |      2       |  雷达类型   |
|      | serial_number |     4      |      4       |   雷达SN    |
|      |   lidar_ip    |     8      |      4       | 雷达IP地址  |
|      |   lidar_mac   |     12     |      6       | 雷达mac地址 |

##### 1.1.4.1.2 0x0001 心跳保持

请求

| CMD  | 名称     | 偏移(字节) | 大小（字节） | 描述     |
| :--: | -------- | ---------- | ------------ | -------- |
| data | dev_type | 0          | 2            | 雷达类型 |

应答

| ACK  |   名称   | 偏移(字节) | 大小（字节） |  描述  |
| :--: | :------: | :--------: | :----------: | :----: |
| data | ret_code |     0      |      2       | 返回码 |

#### 1.1.4.2 雷达参数设置

##### 1.1.4.2.1 0x0100 请求连接

请求

| CMD  |      名称       | 偏移(字节) | 大小（字节） |      描述      |
| :--: | :-------------: | :--------: | :----------: | :------------: |
| data | permission_type |     0      |      2       |    权限类型    |
|      |    password     |     2      |      4       | 权限对应的密码 |

示例：

|   名称   | 头信息                        | 头校验和 | 数据              | 数据校验和 |
| :------: | :---------------------------- | :------- | :---------------- | :--------- |
| 发送数据 | 03 03 00 00 14 00 01 00 00 00 | 00 1B    | 00 02 20 21 05 18 | 00 60      |
| 返回数据 | 03 03 00 00 10 01 01 00 00 00 | 00 18    | 00 00             | 00 00      |



##### 1.1.4.2.2 0x0101 断开连接

请求

| CMD  | 名称 | 偏移(字节) | 大小（字节） | 描述 |
| :--: | :--: | :--------: | :----------: | ---- |
| data | res  |     0      |      2       | 预留 |

示例：

|   名称   | 头信息                        | 头校验和 | 数据  | 数据校验和 |
| :------: | :---------------------------- | :------- | :---- | :--------- |
| 发送数据 | 03 03 00 00 10 00 01 01 00 00 | 00 18    | 00 00 | 00 00      |
| 返回数据 | 03 03 00 00 10 01 01 01 00 00 | 00 19    | 00 00 | 00 00      |

##### 1.1.4.2.3 0x0102 保存雷达参数

请求

| CMD  | 名称 | 偏移(字节) | 大小（字节） | 描述 |
| :--: | :--: | :--------: | :----------: | :--: |
| data | res  |     0      |      2       | 预留 |

示例：

|   名称   | 头信息                        | 头校验和 | 数据  | 数据校验和 |
| :------: | :---------------------------- | :------- | :---- | :--------- |
| 发送数据 | 03 03 00 00 10 00 01 02 00 00 | 00 19    | 00 00 | 00 00      |
| 返回数据 | 03 03 00 00 10 01 01 02 00 00 | 00 1A    | 00 00 | 00 00      |

##### 1.1.4.2.4 0x0103 设置雷达IP

请求

| CMD  |   名称   | 偏移(字节) | 大小（字节） | 描述       |
| :--: | :------: | :--------: | :----------: | ---------- |
| data | lidar_ip |     0      |      4       | 雷达ip地址 |

示例：

|   名称   | 头信息                        | 头校验和 | 数据        | 数据校验和 |
| :------: | :---------------------------- | :------- | :---------- | :--------- |
| 发送数据 | 03 03 00 00 12 00 01 03 00 00 | 00 1C    | C0 A8 01 6F | 01 D8      |
| 返回数据 | 03 03 00 00 12 01 01 03 00 00 | 00 1D    | 00 00       | 00 00      |

##### 1.1.4.2.5 0x0104 设置雷达mac

请求

| CMD  |   名称    | 偏移(字节) | 大小（字节） | 描述        |
| :--: | :-------: | :--------: | :----------: | ----------- |
| data | lidar_mac |     0      |      6       | 雷达mac地址 |

示例：

|   名称   | 头信息                        | 头校验和 | 数据              | 数据校验和 |
| :------: | :---------------------------- | :------- | :---------------- | :--------- |
| 发送数据 | 03 03 00 00 14 00 01 04 00 00 | 00 1F    | 11 22 33 44 55 66 | 01 65      |
| 返回数据 | 03 03 00 00 14 01 01 04 00 00 | 00 20    | 00 00             | 00 00      |

##### 1.1.4.2.8 0x0107 设置雷达发光编号（0~7）

请求

| CMD  |        名称        | 偏移(字节) | 大小（字节） | 描述         |
| :--: | :----------------: | :--------: | :----------: | ------------ |
| data | lidar_laser_sernum |     0      |      1       | 雷达发光编号 |

示例：

|   名称   | 头信息                        | 头校验和 | 数据  | 数据校验和 |
| :------: | :---------------------------- | :------- | :---- | :--------- |
| 发送数据 | 03 03 00 00 0F 00 01 07 00 00 | 00 1D    | 01    | 00 01      |
| 返回数据 | 03 03 00 00 10 01 01 07 00 00 | 00 1F    | 00 00 | 00 00      |

##### 1.1.4.2.9 0x0108 设置雷达电机开关

请求

| CMD  |    名称     | 偏移(字节) | 大小（字节） | 描述      |
| :--: | :---------: | :--------: | :----------: | --------- |
| data | r_motor_sw1 |     0      |      1       | 电机1开关 |
|      | r_motor_sw2 |     1      |      1       | 电机2开关 |

示例：

|   名称   |            头信息             | 头校验和 | 数据  | 数据校验和 |
| :------: | :---------------------------: | :------: | :---: | :--------: |
| 发送数据 | 03 03 00 00 10 00 01 08 00 00 |  00 1F   | 00 00 |   00 00    |
| 返回数据 | 03 03 00 00 10 01 01 08 00 00 |  00 20   | 00 00 |   00 00    |

##### 1.1.4.2.10 0x0109 设置雷达高压参数

请求

| CMD  |        名称         | 偏移(字节) | 大小（字节） | 描述           |
| :--: | :-----------------: | :--------: | :----------: | -------------- |
| data |  lidar_apdhv_base   |     0      |      2       | 雷达高压基准值 |
|      |   lidar_temp_base   |     2      |      2       | 雷达温度基准值 |
|      |  lidar_hvcp_switch  |     4      |      1       | 高压补偿开关   |
|      | lidar_tempcp_switch |     5      |      1       | 温度补偿开关   |

示例：

|   名称   |            头信息             | 头校验和 |       数据        | 数据校验和 |
| :------: | :---------------------------: | :------: | :---------------: | :--------: |
| 发送数据 | 03 03 00 00 14 00 01 09 00 00 |  00 24   | 03 33 00 1E 00 00 |   00 54    |
| 返回数据 | 03 03 00 00 10 01 01 09 00 00 |  00 21   |       00 00       |   00 00    |

##### 1.1.4.2.11 0x010A 设置雷达电机频率

请求

| CMD  |     名称      | 偏移(字节) | 大小（字节） | 描述            |
| :--: | :-----------: | :--------: | :----------: | --------------- |
| data | r_freq_motor1 |     0      |      2       | 电机1频率设置值 |
|      | r_freq_motor2 |     2      |      2       | 电机2频率设置值 |

示例：

|   名称   |            头信息             | 头校验和 |    数据     | 数据校验和 |
| :------: | :---------------------------: | :------: | :---------: | :--------: |
| 发送数据 | 03 03 00 00 12 00 01 0A 00 00 |  00 23   | 00 0A 00 0A |   00 14    |
| 返回数据 | 03 03 00 00 10 01 01 0A 00 00 |  00 22   |    00 00    |   00 00    |

##### 1.1.4.2.12 0x010B 设置雷达发光模式开关

请求

| CMD  |      名称      | 偏移(字节) | 大小（字节） | 描述                                                         |
| :--: | :------------: | :--------: | :----------: | ------------------------------------------------------------ |
| data | r_laser_switch |     0      |      1       | 0x00： 8个发光点循环发光<br />0x01： 8个发光点只有一个发光，发光点根据发光编号设置值发光<br /> |

示例：

|   名称   |            头信息             | 头校验和 | 数据  | 数据校验和 |
| :------: | :---------------------------: | :------: | :---: | :--------: |
| 发送数据 | 03 03 00 00 0F 00 01 0B 00 00 |  00 21   |  01   |   00 01    |
| 返回数据 | 03 03 00 00 10 01 01 0B 00 00 |  00 23   | 00 00 |   00 00    |

#### 1.1.4.3 雷达参数查询

##### 1.1.4.3.1 0x0200 查询雷达IP

请求

| CMD  | 名称 | 偏移(字节) | 大小（字节） | 描述 |
| :--: | :--: | :--------: | :----------: | :--: |
| data | res  |     0      |      2       | 预留 |

应答

| ACK  |   名称   | 偏移(字节) | 大小（字节） |      描述      |
| :--: | :------: | :--------: | :----------: | :------------: |
| data | ret_code |     0      |      2       |     返回码     |
|      | lidar_ip |     2      |      4       | 雷达ip信息返回 |

示例：

|   名称   |            头信息             | 头校验和 |       数据        | 数据校验和 |
| :------: | :---------------------------: | :------: | :---------------: | :--------: |
| 发送数据 | 03 03 00 00 10 00 02 00 00 00 |  00 18   |       00 00       |   00 00    |
| 返回数据 | 03 03 00 00 14 01 02 00 00 00 |  00 1D   | 00 00 C0 A8 01 6F |   01 D8    |

##### 1.1.4.3.2 0x0201 查询雷达MAC

请求

| CMD  | 名称 | 偏移(字节) | 大小（字节） | 描述 |
| :--: | :--: | :--------: | :----------: | :--: |
| data | res  |     0      |      2       | 预留 |

应答

| ACK  |   名称    | 偏移(字节) | 大小（字节） |      描述       |
| :--: | :-------: | :--------: | :----------: | :-------------: |
| data | ret_code  |     0      |      2       |     返回码      |
|      | lidar_mac |     2      |      6       | 雷达mac信息返回 |

示例：

|   名称   |            头信息             | 头校验和 |          数据           | 数据校验和 |
| :------: | :---------------------------: | :------: | :---------------------: | :--------: |
| 发送数据 | 03 03 00 00 10 00 02 01 00 00 |  00 19   |          00 00          |   00 00    |
| 返回数据 | 03 03 00 00 16 01 02 01 00 00 |  00 20   | 00 00 11 22 33 44 55 66 |   01 65    |

##### 1.1.4.3.3 0x0202 查询雷达版本号

请求

| CMD  | 名称 | 偏移(字节) | 大小（字节） | 描述 |
| :--: | :--: | :--------: | :----------: | :--: |
| data | res  |     0      |      2       | 预留 |

应答

| ACK  |      名称      | 偏移(字节) | 大小（字节） |       描述       |
| :--: | :------------: | :--------: | :----------: | :--------------: |
| data |    ret_code    |     0      |      2       |      返回码      |
|      | lidar_firmware |     2      |      4       | 雷达版本信息返回 |

示例：

|   名称   |            头信息             | 头校验和 |       数据        | 数据校验和 |
| :------: | :---------------------------: | :------: | :---------------: | :--------: |
| 发送数据 | 03 03 00 00 10 00 02 02 00 00 |  00 19   |       00 00       |   00 00    |
| 返回数据 | 03 03 00 00 14 01 02 02 00 00 |  00 1F   | 00 00 25 04 15 19 |   00 57    |

##### 1.1.4.3.10 0x0209 查询雷达高压参数值

请求

| CMD  | 名称 | 偏移(字节) | 大小（字节） | 描述 |
| :--: | :--: | :--------: | :----------: | :--: |
| data | res  |     0      |      2       | 预留 |

应答

| ACK  |        名称         | 偏移(字节) | 大小（字节） |      描述      |
| :--: | :-----------------: | :--------: | :----------: | :------------: |
| data |      ret_code       |     0      |      2       |     返回码     |
|      |  lidar_apdhv_base   |     2      |      2       | 雷达高压基准值 |
|      |   lidar_temp_base   |     4      |      2       | 雷达温度基准值 |
|      |  lidar_hvcp_switch  |     6      |      1       |  高压补偿开关  |
|      | lidar_tempcp_switch |     7      |      1       |  温度补偿开关  |

示例：

|   名称   |            头信息             | 头校验和 |          数据           | 数据校验和 |
| :------: | :---------------------------: | :------: | :---------------------: | :--------: |
| 发送数据 | 03 03 00 00 10 00 02 09 00 00 |  00 21   |          00 00          |   00 00    |
| 返回数据 | 03 03 00 00 16 01 02 09 00 00 |  00 28   | 00 00 03 33 00 1E 00 00 |   00 54    |

#### 1.1.4.4 雷达系数相关

##### 1.1.4.4.1 0x0300 写入距离计算系数

请求

| CMD  |    名称    | 偏移(字节) | 大小（字节） |   描述   |
| :--: | :--------: | :--------: | :----------: | :------: |
| data | coe_sernum |     0      |      2       | 系数编号 |
|      |  coe_data  |     2      |     1024     |   系数   |

应答

| ACK  |   名称   | 偏移(字节) | 大小（字节） |  描述  |
| :--: | :------: | :--------: | :----------: | :----: |
| data | ret_code |     0      |      2       | 返回码 |

##### 1.1.4.4.2 0x0301 查询距离计算系数

请求

| CMD  |    名称    | 偏移(字节) | 大小（字节） |   描述   |
| :--: | :--------: | :--------: | :----------: | :------: |
| data | coe_sernum |     0      |      2       | 系数编号 |

应答

| ACK  |    名称    | 偏移(字节) | 大小（字节） |   描述   |
| :--: | :--------: | :--------: | :----------: | :------: |
| data |  ret_code  |     0      |      2       |  返回码  |
|      | coe_sernum |     2      |      2       | 系数编号 |
|      |  coe_data  |     4      |     1024     |   系数   |

##### 1.1.4.4.2 0x0302 写入反射率计算系数

请求

| CMD  |    名称    | 偏移(字节) | 大小（字节） |   描述   |
| :--: | :--------: | :--------: | :----------: | :------: |
| data | coe_sernum |     0      |      2       | 系数编号 |

应答

| ACK  |    名称    | 偏移(字节) | 大小（字节） |   描述   |
| :--: | :--------: | :--------: | :----------: | :------: |
| data |  ret_code  |     0      |      2       |  返回码  |
|      | coe_sernum |     2      |      2       | 系数编号 |
|      |  coe_data  |     4      |     1024     |   系数   |

#### 1.1.4.5 雷达测试相关指令

##### 1.1.4.5.1 0x2000 输出标定数据

请求

| CMD  |      名称       | 偏移(字节) | 大小（字节） |     描述     |
| :--: | :-------------: | :--------: | :----------: | :----------: |
| data | r_cali_pointnum |     0      |      2       | 标定取数点数 |

示例：

|   名称   |            头信息             | 头校验和 | 数据  | 数据校验和 |
| :------: | :---------------------------: | :------: | :---: | :--------: |
| 发送数据 | 03 03 00 00 10 00 20 00 00 00 |  00 36   | 13 88 |   13 88    |
| 返回数据 |                               |          |       |            |

## 1.2点云数据（指令号0x1001）

帧格式如下：

|      字段       | 偏移（字节） | 大小（字节） | 描述                                                         |
| :-------------: | :----------: | :----------: | :----------------------------------------------------------- |
|       sof       |      0       |      2       | 04 04                                                        |
|     version     |      2       |      1       | 当前协议版本为2                                              |
|   lidar_type    |      3       |      1       | 01：DF1                                                      |
|     seq_num     |      4       |      2       | 每条新的REQ请求消息此字段递增1；<br/>ACK回复消息此字段与REQ相同，可用于消息匹配； |
|     reserve     |      6       |      2       | 保留                                                         |
|     length      |      8       |      2       | 指令帧总长度（字节）                                         |
| Header Checksum |      10      |      2       | 和校验（作用域为sof~length)                                  |
|   lidar_state   |      12      |      4       | 雷达状态信息                                                 |
|    **data**     |    **16**    |   **800**    | **数据**                                                     |
|  Data Checksum  |     816      |      2       | 和校验（作用域为data）                                       |

请求：控制指令端口

| CMD  |       名称        | 偏移(字节) | 大小（字节） |                描述                |
| :--: | :---------------: | :--------: | :----------: | :--------------------------------: |
| data | r_loopdata_switch |     0      |      1       | 0x00： 关闭<br />0x01： 打开<br /> |

示例：

|   名称   |            头信息             | 头校验和 | 数据 | 数据校验和 |
| :------: | :---------------------------: | :------: | :--: | :--------: |
| 发送数据 | 03 03 00 00 0F 00 10 01 00 00 |  00 26   |  01  |   00 01    |
| 返回数据 |                               |          |      |            |

## 1.3上位机/SDK连接流程

| 数据类型 |    传输方向     | 雷达端口号 | 上位机端口号 | 传输类型 | 传输协议 |
| :------: | :-------------: | :--------: | :----------: | :------: | :------: |
| 设备信息 | 雷达---->上位机 |   55000    |    65000     |   广播   |   UDP    |
| 控制指令 | 上位机---->雷达 |   55100    |    65000     |   单播   |   UDP    |
| 标定数据 | 雷达---->上位机 |   55200    |     任意     |   单播   |   UDP    |
| 点云数据 | 雷达---->上位机 |   55300    |    65000     |   单播   |   UDP    |
| IMU数据  | 雷达---->上位机 |   55400    |    65000     |   单播   |   UDP    |
| 心跳端口 | 上位机---->雷达 |   55600    |     任意     |   单播   |   UDP    |

建立连接：

1. 上位机向**55100**端口发送连接请求命令
2. 雷达接收到连接请求命令后，检测密码是否正确
3. 上位机发送连接请求成功后开始发送心跳包数据维持连接，**建立连接后可以停止广播**，心跳需要一直维持

## 1.4雷达上电工作流程

雷达IP可更改，需要等待参数加载完成后建立连接，协议解析在数据层操作，识别当前端口号